# config/nginx/conf.d/security.conf
# Configuration de sécurité globale Nginx

# ===========================================
# PROTECTION CONTRE LES ATTAQUES COURANTES
# ===========================================

# Bloquer les user-agents malveillants connus
map $http_user_agent $bad_bot {
    default 0;
    ~*^$ 1;                                    # User-agent vide
    ~*(bot|crawl|spider|scan) 1;               # Bots génériques (sauf moteurs légitimes)
    ~*(nikto|sqlmap|nmap|masscan) 1;           # Outils de scan
    ~*(wget|curl|libwww|python|perl|ruby) 1;   # Scripts (à adapter selon besoins)
}

# Bloquer les referrers spam
map $http_referer $bad_referer {
    default 0;
    ~*(semalt|buttons-for-website|darodar) 1;
}

# ===========================================
# RATE LIMITING AVANCÉ
# ===========================================

# Zone pour les requêtes d'authentification (plus restrictive)
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;

# Zone pour les requêtes API générales
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

# Zone pour les uploads
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=1r/s;

# ===========================================
# BLOCAGE GÉO (optionnel)
# ===========================================
# Décommenter et configurer si nécessaire
# geo $blocked_country {
#     default 0;
#     # Bloquer certains pays (codes ISO)
#     # include /etc/nginx/conf.d/blocked_countries.conf;
# }

# ===========================================
# LISTE BLANCHE / LISTE NOIRE IP
# ===========================================

# IPs autorisées pour l'administration
geo $admin_allowed {
    default 0;
    127.0.0.1 1;
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
    # Ajouter vos IPs d'administration
    # x.x.x.x 1;
}

# IPs bloquées (attaquants connus)
geo $blocked_ip {
    default 0;
    # Ajouter les IPs à bloquer
    # x.x.x.x 1;
}

# ===========================================
# PROTECTION CONTRE LES INJECTIONS
# ===========================================

# Bloquer les tentatives d'injection SQL basiques
map $query_string $block_sql_injection {
    default 0;
    ~*union.*select 1;
    ~*select.*from 1;
    ~*insert.*into 1;
    ~*drop.*table 1;
    ~*update.*set 1;
    ~*delete.*from 1;
    ~*'.*or.*' 1;
    ~*'.*and.*' 1;
    ~*exec\s*\( 1;
    ~*script.*> 1;
}

# Bloquer les traversées de répertoires
map $uri $block_traversal {
    default 0;
    ~*\.\./ 1;
    ~*\.\.\\  1;
    ~*/etc/passwd 1;
    ~*/etc/shadow 1;
    ~*/proc/self 1;
}

# ===========================================
# SERVEUR POUR APPLIQUER LES RÈGLES
# ===========================================

# Ce bloc peut être inclus dans les server blocks
# ou utilisé comme configuration de référence

# Exemple d'application dans un server block:
# server {
#     # Bloquer les mauvais bots
#     if ($bad_bot) {
#         return 403;
#     }
#     
#     # Bloquer les referrers spam
#     if ($bad_referer) {
#         return 403;
#     }
#     
#     # Bloquer les IPs blacklistées
#     if ($blocked_ip) {
#         return 403;
#     }
#     
#     # Bloquer les injections SQL
#     if ($block_sql_injection) {
#         return 403;
#     }
#     
#     # Bloquer les traversées
#     if ($block_traversal) {
#         return 403;
#     }
# }

# ===========================================
# CONFIGURATION SSL/TLS (si terminaison Nginx)
# ===========================================

# Note: En production, Traefik gère la terminaison TLS
# Cette configuration est pour les cas où Nginx termine TLS directement

# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
# ssl_prefer_server_ciphers off;
# ssl_session_timeout 1d;
# ssl_session_cache shared:SSL:50m;
# ssl_session_tickets off;
# ssl_stapling on;
# ssl_stapling_verify on;