# config/nginx/modsec/main.conf
# Configuration ModSecurity (WAF) pour MSSanté Operator

# ===========================================
# CONFIGURATION PRINCIPALE MODSECURITY
# ===========================================

# Activer ModSecurity
SecRuleEngine On

# Mode de détection (DetectionOnly) ou blocage (On)
# En développement, utiliser DetectionOnly pour tester
# SecRuleEngine DetectionOnly

# ===========================================
# LOGGING
# ===========================================

# Fichier de log des audits
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Log de debug (désactiver en production)
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 0

# ===========================================
# CONFIGURATION DES REQUÊTES
# ===========================================

# Taille maximale du corps de requête (50MB pour les pièces jointes)
SecRequestBodyAccess On
SecRequestBodyLimit 52428800
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Taille maximale du corps de réponse
SecResponseBodyAccess On
SecResponseBodyLimit 524288
SecResponseBodyMimeType text/plain text/html text/xml application/json

# ===========================================
# FICHIERS TEMPORAIRES
# ===========================================

SecTmpDir /tmp/modsecurity/tmp
SecDataDir /tmp/modsecurity/data
SecUploadDir /tmp/modsecurity/upload
SecUploadKeepFiles Off

# ===========================================
# RÈGLES OWASP CRS (Core Rule Set)
# ===========================================

# Inclure la configuration CRS
Include /etc/nginx/modsec/owasp-crs/crs-setup.conf

# Inclure toutes les règles CRS
Include /etc/nginx/modsec/owasp-crs/rules/*.conf

# ===========================================
# EXCLUSIONS SPÉCIFIQUES MSSANTÉ
# ===========================================

# Exclure certains faux positifs pour l'API
# Authentification PSC (tokens longs)
SecRule REQUEST_URI "@beginsWith /api/v1/auth" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942200"

# Upload de pièces jointes
SecRule REQUEST_URI "@beginsWith /api/v1/attachments" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveById=200002"

# Contenu des emails (peut contenir du HTML)
SecRule REQUEST_URI "@beginsWith /api/v1/email" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160"

# ===========================================
# RÈGLES PERSONNALISÉES MSSANTÉ
# ===========================================

# Bloquer les tentatives d'accès à des chemins sensibles
SecRule REQUEST_URI "@contains /admin" \
    "id:2000,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Tentative accès admin non autorisé',\
    tag:'mssante/admin-access'"

# Bloquer les tentatives d'exploitation de vulnérabilités connues
SecRule REQUEST_URI "@contains /wp-admin" \
    "id:2001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Scan WordPress détecté',\
    tag:'mssante/scan-detection'"

SecRule REQUEST_URI "@rx (?:phpinfo|phpmyadmin|adminer)" \
    "id:2002,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Scan outils PHP détecté',\
    tag:'mssante/scan-detection'"

# Protection contre les attaques par force brute sur l'authentification
SecRule REQUEST_URI "@beginsWith /api/v1/auth/login" \
    "id:2010,\
    phase:1,\
    pass,\
    nolog,\
    setvar:ip.login_attempts=+1,\
    expirevar:ip.login_attempts=60"

SecRule IP:LOGIN_ATTEMPTS "@gt 10" \
    "id:2011,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Trop de tentatives de connexion',\
    tag:'mssante/brute-force'"

# ===========================================
# PROTECTION DONNÉES DE SANTÉ
# ===========================================

# Masquer les numéros de sécurité sociale dans les logs
SecRule RESPONSE_BODY "@rx \b[12][0-9]{2}(0[1-9]|1[0-2])[0-9]{2}[0-9]{3}[0-9]{3}[0-9]{2}\b" \
    "id:3000,\
    phase:4,\
    pass,\
    log,\
    msg:'Numéro de sécurité sociale détecté dans la réponse',\
    tag:'mssante/data-leakage'"

# Alerter sur les RPPS dans les logs (11 chiffres)
SecRule RESPONSE_BODY "@rx \b[0-9]{11}\b" \
    "id:3001,\
    phase:4,\
    pass,\
    nolog,\
    tag:'mssante/rpps-detected'"

# ===========================================
# HEADERS DE RÉPONSE
# ===========================================

# Ajouter des headers de sécurité si pas déjà présents
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
    "id:4000,\
    phase:3,\
    pass,\
    nolog,\
    append:'X-Frame-Options: SAMEORIGIN'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
    "id:4001,\
    phase:3,\
    pass,\
    nolog,\
    append:'X-Content-Type-Options: nosniff'"