# config/traefik/dynamic.yml
# Configuration dynamique Traefik pour MSSanté Operator

# Configuration TLS
tls:
  options:
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
        - TLS_AES_256_GCM_SHA384
        - TLS_AES_128_GCM_SHA256
        - TLS_CHACHA20_POLY1305_SHA256
      sniStrict: true
    
    # Option TLS stricte pour MSSanté (TLS 1.3 uniquement)
    mssante-strict:
      minVersion: VersionTLS13
      sniStrict: true

  # Certificats IGC Santé
  certificates:
    - certFile: /certificates/server/fullchain.pem
      keyFile: /certificates/server/server.key
      stores:
        - default

  stores:
    default:
      defaultCertificate:
        certFile: /certificates/server/fullchain.pem
        keyFile: /certificates/server/server.key

# Configuration HTTP
http:
  # Routers
  routers:
    # Frontend - Application Web
    frontend:
      rule: "Host(`votre-domaine.mssante.fr`)"
      entryPoints:
        - websecure
      service: frontend
      tls:
        certResolver: letsencrypt
        options: default
      middlewares:
        - security-headers
        - rate-limit
    
    # API Backend
    api:
      rule: "Host(`api.votre-domaine.mssante.fr`)"
      entryPoints:
        - websecure
      service: api
      tls:
        certResolver: letsencrypt
        options: default
      middlewares:
        - security-headers
        - rate-limit
        - cors
    
    # Dashboard Traefik (à sécuriser en production)
    dashboard:
      rule: "Host(`traefik.votre-domaine.mssante.fr`)"
      entryPoints:
        - websecure
      service: api@internal
      tls:
        certResolver: letsencrypt
      middlewares:
        - auth-basic

  # Services
  services:
    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s
    
    api:
      loadBalancer:
        servers:
          - url: "http://api:3000"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

  # Middlewares
  middlewares:
    # En-têtes de sécurité
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        referrerPolicy: "strict-origin-when-cross-origin"
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    
    # Limitation de débit
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1m
    
    # CORS pour l'API
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
        accessControlAllowOriginList:
          - "https://votre-domaine.mssante.fr"
        accessControlMaxAge: 86400
        addVaryHeader: true
    
    # Authentification basique pour le dashboard
    auth-basic:
      basicAuth:
        users:
          # admin:admin (à changer en production!)
          # Générer avec: htpasswd -nb admin votre-mot-de-passe
          - "admin:$apr1$ruca84Hq$mbjdMZBAG.KWn7vfN/SNK/"
    
    # Compression
    compress:
      compress:
        excludedContentTypes:
          - text/event-stream

# Configuration TCP pour les services mail
tcp:
  routers:
    # SMTP
    smtp:
      entryPoints:
        - smtp
      rule: "HostSNI(`*`)"
      service: postfix-smtp
      tls:
        passthrough: true
    
    # SMTP Submission
    submission:
      entryPoints:
        - submission
      rule: "HostSNI(`*`)"
      service: postfix-submission
      tls:
        passthrough: true
    
    # IMAP
    imap:
      entryPoints:
        - imap
      rule: "HostSNI(`*`)"
      service: dovecot-imap
      tls:
        passthrough: true

  services:
    postfix-smtp:
      loadBalancer:
        servers:
          - address: "postfix:25"
    
    postfix-submission:
      loadBalancer:
        servers:
          - address: "postfix:587"
    
    dovecot-imap:
      loadBalancer:
        servers:
          - address: "dovecot:143"